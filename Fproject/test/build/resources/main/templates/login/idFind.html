<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta id="_csrf" name="_csrf" th:content="${_csrf.token}"/>
    <meta id="_csrf_header" name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>아이디 찾기</title>
    <script th:inline="javascript" src="https://code.jquery.com/jquery-3.6.1.js" integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI=" crossorigin="anonymous"></script>
</head>
<style>
.modal {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 1254px;
    display: none;
    background-color: rgba(0, 0, 0, 0.4);

}
.modal_body {
  position: absolute;
  top: 25%;
  left: 50%;
  width: 350px;
  height: 350px;
  padding: 40px;
  text-align: center;
  background-color: rgb(255, 255, 255);
  border-radius: 10px;
  box-shadow: 0 2px 3px 0 rgba(34, 36, 38, 0.15);

  transform: translateX(-50%) translateY(-50%);
}
</style>
<body>
  <form action="/members/findId" method="post">
    이름 <input type="text" id="name" name="name"><br>
    이메일<input type="email" id="email" name="email">
    <button type="button" class="btn-3d red" id="modalbtn" onclick="emailChk()">이메일 인증</button><br/>
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
    <input type="submit" value="찾기">
  </form>
  <div class="modal">
      <div class="modal_body">
          <div id="texth4"><h3>이메일</h3><h3 id="red">인증코드를</h3><h3>입력해주세요.</h3></div>
          <input type="text" id="code" name="code"/>
          <input type="text" th:value="${authCode}" id="code1" name="code1">
          <button type="submit" name="email" value="확인" onclick="check()">확인</button>
          <button id="cbtn" class="withdraw">아니요</button>
      </div>
  </div>
<script>
    const modal = document.querySelector('.modal');
    const btnOpenPopup = document.querySelector('#modalbtn');
    const modalClose = document.querySelector('#cbtn');
    btnOpenPopup.addEventListener('click', () => {
        modal.style.display = 'block';
        window.scrollTo({top: 0});
    });
    modal.addEventListener("click", e => {
     const evTarget = e.target
        if(evTarget.classList.contains("modal")) {
     modal.style.display = "none"
    }});
    modalClose.addEventListener('click', () => {
        modal.style.display = "none";
    });
</script>
<script th:inline="javascript">
    function check() {
        console.log("체크펑션")
        var code = [[${authCode}]]
        console.log(code)
        if(document.getElementById('code').value==code){
           alert("인증이 완료되었습니다.")
        }else{
            console.log(document.getElementById('code').value)
            alert("인증에 실패하셨습니다.")
            }
    }
    function emailChk(){
    console.log("이메일보내기 콘솔");
    var email = $('#email').val();
    var name = $('#name').val();
    var data = {
        name: $('#name').val(),
        email: $('#email').val(),
    };
    console.log(email);
    var id = $('#id').val();
    var token = $("meta[name='_csrf']").attr("content");
    var header = $("meta[name='_csrf_header']").attr("content");
    console.log(token);
    console.log("이메일보내기 콘솔1");
        $.ajax({
            beforeSend: function(xhr){
                xhr.setRequestHeader(header,token);
                },
                type : 'POST',
                url : '/emailCheck/'+email+'/'+name,
                dataType : 'json',
                contentType : 'application/json; charset=utf-8',
        }).done(function(data){
            alert('인증번호를 발송하였습니다.');
            console.log('dl')
            $('#code1').val(data.authCode);
        }).fail(function(error){
            alert(JSON.stringify(error));
        });
        console.log(token);
        console.log(header);
        console.log(data.content);
    };

</script>
<script th:inline="javascript">
  $(document).ready(function(){
      var errorMessage = [[${errorMessage}]];
      if(errorMessage != null){
          alert(errorMessage);
      }
  });
</script>

</body>
</html>